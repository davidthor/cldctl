# Native module for running a shared PostgreSQL server in Docker.
#
# This module creates a single persistent PostgreSQL instance at the
# datacenter level, shared across all environments. Individual databases
# are created per-environment by the docker-postgres-database module.
#
# Because the volume and container live at the datacenter level, data
# survives environment destroy/recreate cycles. Re-deploying an
# environment only runs incremental migrations (seconds instead of
# minutes).
plugin: native
type: docker

inputs:
  name:
    type: string
    required: true
    description: Container and volume name for the shared PostgreSQL server
  network:
    type: string
    required: true
    description: Docker network to join
  port:
    type: number
    default: 5432
    description: Host port to expose PostgreSQL on (0 for dynamic)

resources:
  volume:
    type: docker:volume
    properties:
      name: "${inputs.name}-data"
  
  container:
    type: docker:container
    depends_on: [volume]
    properties:
      image: "pgvector/pgvector:pg16"
      name: "${inputs.name}"
      network: "${inputs.network}"
      environment:
        POSTGRES_USER: "postgres"
        POSTGRES_PASSWORD: "localdevpassword"
      ports:
        - container: 5432
          host: "${inputs.port}"
      volumes:
        - name: "${inputs.name}-data"
          path: /var/lib/postgresql/data
      healthcheck:
        command: ["pg_isready", "-U", "postgres"]
        interval: 2s
        timeout: 3s
        retries: 15
      restart: unless-stopped

outputs:
  host:
    value: "${inputs.name}"
    description: Database host (container name for Docker network access)
  port:
    value: "5432"
    description: Database port (internal container port)
  host_port:
    value: "${resources.container.ports[0].host}"
    description: Database port on host (for host-based access)
  container_name:
    value: "${inputs.name}"
    description: Container name (for docker exec commands)
  container_id:
    value: "${resources.container.id}"
    description: Docker container ID
