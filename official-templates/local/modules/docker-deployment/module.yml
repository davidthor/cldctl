# Native module for running deployments as Docker containers
plugin: native
type: docker

inputs:
  name:
    type: string
    required: true
    description: Container name
  image:
    type: string
    required: true
    description: Docker image to run
  command:
    type: list
    description: Override container command
  entrypoint:
    type: list
    description: Override container entrypoint
  environment:
    type: map
    default: {}
    description: Environment variables
  cpu:
    type: string
    description: CPU limit (e.g., "0.5")
  memory:
    type: string
    description: Memory limit (e.g., "512Mi")
  network:
    type: string
    required: true
    description: Docker network to join
  liveness_probe:
    type: map
    description: Health check configuration (optional)
  log_driver:
    type: string
    description: Docker logging driver (e.g., "fluentd", "json-file")
  log_driver_options:
    type: map
    default: {}
    description: Options for the Docker logging driver

resources:
  # Container WITH health check (when liveness_probe is provided)
  # Exposes the liveness_probe port to the host for service discovery/routing
  container_hc:
    type: docker:container
    when: "${inputs.liveness_probe != null}"
    properties:
      image: "${inputs.image}"
      name: "${inputs.name}"
      network: "${inputs.network}"
      command: "${inputs.command}"
      entrypoint: "${inputs.entrypoint}"
      environment: "${inputs.environment}"
      ports:
        - container: "${inputs.liveness_probe.port}"
          host: "${inputs.liveness_probe.port}"
      resources:
        cpu: "${inputs.cpu}"
        memory: "${inputs.memory}"
      healthcheck:
        command: ["curl", "-f", "http://localhost:${inputs.liveness_probe.port}${inputs.liveness_probe.path}"]
        interval: 10s
        timeout: 10s
        retries: 18
        start_period: 30s
      restart: unless-stopped
      resolve_localhost: true
      log_driver: "${inputs.log_driver}"
      log_options: "${inputs.log_driver_options}"

  # Container WITHOUT health check (when liveness_probe is not provided)
  container:
    type: docker:container
    when: "${inputs.liveness_probe == null}"
    properties:
      image: "${inputs.image}"
      name: "${inputs.name}"
      network: "${inputs.network}"
      command: "${inputs.command}"
      entrypoint: "${inputs.entrypoint}"
      environment: "${inputs.environment}"
      resources:
        cpu: "${inputs.cpu}"
        memory: "${inputs.memory}"
      restart: unless-stopped
      resolve_localhost: true
      log_driver: "${inputs.log_driver}"
      log_options: "${inputs.log_driver_options}"

outputs:
  container_id:
    value: "${coalesce(resources.container_hc.id, resources.container.id)}"
    description: Docker container ID
  container_name:
    value: "${inputs.name}"
    description: Container name
