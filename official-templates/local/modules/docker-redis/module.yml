# Native module for running Redis in Docker
plugin: native
type: docker

inputs:
  name:
    type: string
    required: true
    description: Container name
  version:
    type: string
    default: "7"
    description: Redis version
  network:
    type: string
    required: true
    description: Docker network to join
  port:
    type: number
    default: 6379
    description: Host port to expose Redis on

resources:
  volume:
    type: docker:volume
    properties:
      name: "${inputs.name}-data"
  
  container:
    type: docker:container
    depends_on: [volume]
    properties:
      image: "redis:${inputs.version}-alpine"
      name: "${inputs.name}"
      network: "${inputs.network}"
      command: ["redis-server", "--appendonly", "yes"]
      ports:
        - container: 6379
          host: 0
      volumes:
        - name: "${inputs.name}-data"
          path: /data
      healthcheck:
        command: ["redis-cli", "ping"]
        interval: 2s
        timeout: 3s
        retries: 15
      restart: unless-stopped

outputs:
  host:
    value: "${inputs.name}"
    description: Redis host (container name for Docker network access)
  port:
    value: "6379"
    description: Redis port (internal container port)
  host_port:
    value: "${resources.container.ports[0].host}"
    description: Redis port on host (for host-based access)
  url:
    value: "redis://${inputs.name}:6379"
    description: Full connection URL (Docker network)
  host_url:
    value: "redis://localhost:${resources.container.ports[0].host}"
    description: Full connection URL (host access)
  container_id:
    value: "${resources.container.id}"
    description: Docker container ID
