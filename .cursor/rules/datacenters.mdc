---
description: Guidelines for authoring arcctl datacenter configurations (datacenter.dc/hcl)
globs: "**/*.dc,**/datacenter.hcl,**/datacenters/**/*.dc,**/datacenters/**/*.hcl"
alwaysApply: false
---

# Datacenter Authoring Guidelines

Datacenters are platform engineer-focused infrastructure templates in HCL that define how component resources get fulfilled using IaC modules.

## File Structure

```hcl
# Variables for datacenter configuration
variable "cluster_name" {
  type        = string
  description = "Kubernetes cluster name"
  default     = "my-cluster"  # Optional
}

# Datacenter-level modules (shared across environments)
module "network" {
  plugin = "native"           # or "pulumi", "opentofu"
  build  = "./modules/network"
  inputs = {
    name = variable.cluster_name
  }
}

# Environment configuration with hooks
environment {
  # Environment-level modules
  module "namespace" { ... }
  
  # Resource hooks
  database { ... }
  deployment { ... }
  service { ... }
  route { ... }
}
```

## Hook Types

Each hook handles a component resource type:

| Hook | Purpose | Required Outputs |
|------|---------|-----------------|
| `database` | Provision databases | `host`, `port`, `url`, `username`, `password` |
| `task` | One-shot jobs (e.g., migrations) | `id` |
| `bucket` | Object storage | `endpoint`, `bucket`, `accessKeyId`, `secretAccessKey` |
| `encryptionKey` | Encryption keys | RSA/ECDSA: `privateKey`, `publicKey`, `privateKeyBase64`, `publicKeyBase64`; Symmetric: `key`, `keyBase64` |
| `smtp` | Email sending | `host`, `port`, `username`, `password` |
| `deployment` | Container workloads | `id` |
| `function` | Serverless functions | `id`, `endpoint` |
| `service` | Internal networking | `host`, `port`, `url` |
| `route` | External routing | `url`, `host`, `port` |
| `dockerBuild` | Build images | `image` |
| `cronjob` | Scheduled tasks | `id` |
| `observability` | OpenTelemetry config | `endpoint`, `protocol`, `attributes` |

## Expression Context

| Expression | Description |
|------------|-------------|
| `variable.<name>` | Datacenter variables |
| `environment.name` | Current environment name |
| `node.name` | Resource name (in hooks) |
| `node.component` | Component the resource belongs to |
| `node.inputs.<field>` | Resource input values |
| `module.<name>.<output>` | Module output values |

## Hook Pattern

```hcl
database {
  # Conditional - which database types this hook handles
  when = element(split(":", node.inputs.type), 0) == "postgres"
  
  module "postgres" {
    plugin = "native"
    build  = "./modules/docker-postgres"
    inputs = {
      name     = "${environment.name}-${node.component}-${node.name}"
      version  = coalesce(try(element(split(":", node.inputs.type), 1), null), "16")
      database = node.name
    }
  }
  
  # Map module outputs to hook outputs
  outputs = {
    host     = module.postgres.host
    port     = module.postgres.port
    url      = module.postgres.url
    username = module.postgres.username
    password = module.postgres.password
  }
}
```

## Deployment Routing Pattern

Deployments support three modes via `when` conditions:

```hcl
# Container-based (image present)
deployment {
  when = node.inputs.image != null
  module "container" { ... }
}

# VM-based (runtime present, no image)
deployment {
  when = node.inputs.runtime != null && node.inputs.image == null
  module "vm" {
    plugin = "opentofu"
    build  = "./modules/ec2-vm"     # or do-droplet, gce-instance
    inputs = merge(node.inputs, { ... })
  }
}

# Process-based (no image, no runtime - local dev)
deployment {
  when = node.inputs.image == null && node.inputs.runtime == null
  module "process" { ... }
}
```

The `node.inputs.runtime` object contains: `language`, `os`, `arch`, `packages`, `setup`.

## Observability Hook Pattern

The `observability` hook provides OpenTelemetry configuration to workloads. Datacenters can
provide `attributes` alongside `endpoint` and `protocol`. The engine merges datacenter
attributes with component attributes and auto-generated ones (`service.namespace`,
`deployment.environment`) into a single `${{ observability.attributes }}` expression.

```hcl
# Simple: static endpoint with datacenter-level attributes
observability {
  outputs = {
    endpoint = "http://localhost:4318"
    protocol = "http/protobuf"
    attributes = {
      cloud.provider = "local"
    }
  }
}

# Production: provision a shared collector
environment {
  module "otel_collector" {
    plugin = "native"
    build  = "./modules/otel-collector"
    inputs = {
      name = "${environment.name}-otel"
    }
  }

  observability {
    outputs = {
      endpoint = module.otel_collector.endpoint
      protocol = module.otel_collector.protocol
      attributes = {
        cloud.provider = "aws"
        cloud.region   = variable.region
      }
    }
  }
}
```

`node.inputs` for observability hooks: `inject` (bool), `logs` (bool), `traces` (bool), `metrics` (bool), `attributes` (map).

## IaC Plugins

- `native` - Lightweight execution (Docker, processes) for local dev
- `pulumi` - Pulumi IaC modules
- `opentofu` - OpenTofu/Terraform modules

## Built-in Functions

- `coalesce(a, b)` - First non-null value
- `merge(map1, map2)` - Merge maps
- `tostring(value)` - Convert to string
- `format(fmt, args...)` - String formatting
