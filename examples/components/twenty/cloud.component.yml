# Twenty - Open Source CRM
# https://docs.twenty.com/developers/self-host/self-host
#
# This component deploys Twenty using the official Docker images from Docker Hub.
# Twenty is a modern open-source CRM platform that provides data ownership,
# compliance capabilities, and full customization access.

variables:
  # Optional: Google OAuth/Integration
  auth_google_enabled:
    description: "Enable Google SSO authentication"
    default: "false"

  auth_google_client_id:
    description: "Google OAuth client ID"
    default: ""

  auth_google_client_secret:
    description: "Google OAuth client secret"
    sensitive: true
    default: ""

  messaging_provider_gmail_enabled:
    description: "Enable Gmail integration for messaging"
    default: "false"

  calendar_provider_google_enabled:
    description: "Enable Google Calendar integration"
    default: "false"

  # Optional: Microsoft OAuth/Integration
  auth_microsoft_enabled:
    description: "Enable Microsoft SSO authentication"
    default: "false"

  auth_microsoft_client_id:
    description: "Microsoft OAuth client ID"
    default: ""

  auth_microsoft_client_secret:
    description: "Microsoft OAuth client secret"
    sensitive: true
    default: ""

  messaging_provider_microsoft_enabled:
    description: "Enable Microsoft 365 integration for messaging"
    default: "false"

  calendar_provider_microsoft_enabled:
    description: "Enable Microsoft Calendar integration"
    default: "false"

  # Optional: Email configuration
  email_from_address:
    description: "Sender email address for system emails"
    default: ""

  email_from_name:
    description: "Sender name for system emails"
    default: "Twenty"

  email_system_address:
    description: "System email address for administrative emails"
    default: ""

  # Multi-workspace mode
  is_multiworkspace_enabled:
    description: "Enable multi-workspace mode for SaaS-like deployments"
    default: "false"

  default_subdomain:
    description: "Default subdomain for multi-workspace mode"
    default: "app"

  # Token expiry
  access_token_expires_in:
    description: "Duration before access tokens expire (e.g. 7d, 1h)"
    default: "7d"

  login_token_expires_in:
    description: "Duration before login tokens expire (e.g. 1h, 30m)"
    default: "1h"

  # Serverless/Logic Functions
  serverless_type:
    description: "Logic functions driver: LOCAL, LAMBDA, or DISABLED"
    default: "LOCAL"

# Object storage for file uploads
buckets:
  storage:
    type: s3
    description: "Storage bucket for file uploads and attachments"

# SMTP for sending emails
smtp:
  email:
    description: "SMTP server for system emails and notifications"

ports:
  server:
    description: "Port for the server application"

# Encryption key for session security
encryptionKeys:
  app_secret:
    type: symmetric
    bytes: 32

# Databases
databases:
  postgres:
    type: postgres:^16
    migrations:
      image: twentycrm/twenty:latest
      command: ["npx", "-y", "typeorm", "migration:run", "-d", "dist/database/typeorm/core/core.datasource"]
      environment:
        PG_DATABASE_URL: ${{ databases.postgres.url }}

  redis:
    type: redis:^7

# Deployments
deployments:
  # Main server application
  server:
    image: twentycrm/twenty:latest
    environment:
      NODE_PORT: ${{ ports.server.port }}
      # Database
      PG_DATABASE_URL: ${{ databases.postgres.url }}
      # Redis
      REDIS_URL: ${{ databases.redis.url }}
      # Server configuration
      SERVER_URL: ${{ routes.public.url }}
      # Security
      APP_SECRET: ${{ encryptionKeys.app_secret.keyBase64 }}
      # Migrations are handled by a separate task on the database
      DISABLE_DB_MIGRATIONS: "true"
      DISABLE_CRON_JOBS_REGISTRATION: "false"
      # Storage (S3-compatible object storage)
      STORAGE_TYPE: "s3"
      STORAGE_S3_REGION: ${{ buckets.storage.region }}
      STORAGE_S3_NAME: ${{ buckets.storage.bucket }}
      STORAGE_S3_ENDPOINT: ${{ buckets.storage.endpoint }}
      STORAGE_S3_ACCESS_KEY_ID: ${{ buckets.storage.accessKeyId }}
      STORAGE_S3_SECRET_ACCESS_KEY: ${{ buckets.storage.secretAccessKey }}
      # Token expiry
      ACCESS_TOKEN_EXPIRES_IN: ${{ variables.access_token_expires_in }}
      LOGIN_TOKEN_EXPIRES_IN: ${{ variables.login_token_expires_in }}
      # Google OAuth/Integration
      AUTH_GOOGLE_ENABLED: ${{ variables.auth_google_enabled }}
      AUTH_GOOGLE_CLIENT_ID: ${{ variables.auth_google_client_id }}
      AUTH_GOOGLE_CLIENT_SECRET: ${{ variables.auth_google_client_secret }}
      AUTH_GOOGLE_CALLBACK_URL: ${{ routes.public.url }}/auth/google/redirect
      AUTH_GOOGLE_APIS_CALLBACK_URL: ${{ routes.public.url }}/auth/google-apis/get-access-token
      MESSAGING_PROVIDER_GMAIL_ENABLED: ${{ variables.messaging_provider_gmail_enabled }}
      CALENDAR_PROVIDER_GOOGLE_ENABLED: ${{ variables.calendar_provider_google_enabled }}
      # Microsoft OAuth/Integration
      AUTH_MICROSOFT_ENABLED: ${{ variables.auth_microsoft_enabled }}
      AUTH_MICROSOFT_CLIENT_ID: ${{ variables.auth_microsoft_client_id }}
      AUTH_MICROSOFT_CLIENT_SECRET: ${{ variables.auth_microsoft_client_secret }}
      AUTH_MICROSOFT_CALLBACK_URL: ${{ routes.public.url }}/auth/microsoft/redirect
      AUTH_MICROSOFT_APIS_CALLBACK_URL: ${{ routes.public.url }}/auth/microsoft-apis/get-access-token
      MESSAGING_PROVIDER_MICROSOFT_ENABLED: ${{ variables.messaging_provider_microsoft_enabled }}
      CALENDAR_PROVIDER_MICROSOFT_ENABLED: ${{ variables.calendar_provider_microsoft_enabled }}
      # Email configuration
      EMAIL_DRIVER: "smtp"
      EMAIL_FROM_ADDRESS: ${{ variables.email_from_address }}
      EMAIL_FROM_NAME: ${{ variables.email_from_name }}
      EMAIL_SYSTEM_ADDRESS: ${{ variables.email_system_address }}
      EMAIL_SMTP_HOST: ${{ smtp.email.host }}
      EMAIL_SMTP_PORT: ${{ smtp.email.port }}
      EMAIL_SMTP_USER: ${{ smtp.email.username }}
      EMAIL_SMTP_PASSWORD: ${{ smtp.email.password }}
      # Multi-workspace
      IS_MULTIWORKSPACE_ENABLED: ${{ variables.is_multiworkspace_enabled }}
      DEFAULT_SUBDOMAIN: ${{ variables.default_subdomain }}
      # Serverless/Logic Functions
      SERVERLESS_TYPE: ${{ variables.serverless_type }}
    cpu: "1"
    memory: "2Gi"
    replicas: 1
    liveness_probe:
      path: /healthz
      port: ${{ ports.server.port }}
      initial_delay_seconds: 30
    readiness_probe:
      path: /healthz
      port: ${{ ports.server.port }}
      initial_delay_seconds: 15

  # Background worker for async jobs
  worker:
    image: twentycrm/twenty:latest
    command: ["yarn", "worker:prod"]
    environment:
      # Database
      PG_DATABASE_URL: ${{ databases.postgres.url }}
      # Redis
      REDIS_URL: ${{ databases.redis.url }}
      # Server configuration
      SERVER_URL: ${{ routes.public.url }}
      # Security
      APP_SECRET: ${{ encryptionKeys.app_secret.keyBase64 }}
      # Migrations are handled by a separate task on the database
      DISABLE_DB_MIGRATIONS: "true"
      DISABLE_CRON_JOBS_REGISTRATION: "true"
      # Storage (S3-compatible object storage)
      STORAGE_TYPE: "s3"
      STORAGE_S3_REGION: ${{ buckets.storage.region }}
      STORAGE_S3_NAME: ${{ buckets.storage.bucket }}
      STORAGE_S3_ENDPOINT: ${{ buckets.storage.endpoint }}
      STORAGE_S3_ACCESS_KEY_ID: ${{ buckets.storage.accessKeyId }}
      STORAGE_S3_SECRET_ACCESS_KEY: ${{ buckets.storage.secretAccessKey }}
      # Token expiry
      ACCESS_TOKEN_EXPIRES_IN: ${{ variables.access_token_expires_in }}
      LOGIN_TOKEN_EXPIRES_IN: ${{ variables.login_token_expires_in }}
      # Google OAuth/Integration
      AUTH_GOOGLE_ENABLED: ${{ variables.auth_google_enabled }}
      AUTH_GOOGLE_CLIENT_ID: ${{ variables.auth_google_client_id }}
      AUTH_GOOGLE_CLIENT_SECRET: ${{ variables.auth_google_client_secret }}
      AUTH_GOOGLE_CALLBACK_URL: ${{ routes.public.url }}/auth/google/redirect
      AUTH_GOOGLE_APIS_CALLBACK_URL: ${{ routes.public.url }}/auth/google-apis/get-access-token
      MESSAGING_PROVIDER_GMAIL_ENABLED: ${{ variables.messaging_provider_gmail_enabled }}
      CALENDAR_PROVIDER_GOOGLE_ENABLED: ${{ variables.calendar_provider_google_enabled }}
      # Microsoft OAuth/Integration
      AUTH_MICROSOFT_ENABLED: ${{ variables.auth_microsoft_enabled }}
      AUTH_MICROSOFT_CLIENT_ID: ${{ variables.auth_microsoft_client_id }}
      AUTH_MICROSOFT_CLIENT_SECRET: ${{ variables.auth_microsoft_client_secret }}
      AUTH_MICROSOFT_CALLBACK_URL: ${{ routes.public.url }}/auth/microsoft/redirect
      AUTH_MICROSOFT_APIS_CALLBACK_URL: ${{ routes.public.url }}/auth/microsoft-apis/get-access-token
      MESSAGING_PROVIDER_MICROSOFT_ENABLED: ${{ variables.messaging_provider_microsoft_enabled }}
      CALENDAR_PROVIDER_MICROSOFT_ENABLED: ${{ variables.calendar_provider_microsoft_enabled }}
      # Email configuration
      EMAIL_DRIVER: "smtp"
      EMAIL_FROM_ADDRESS: ${{ variables.email_from_address }}
      EMAIL_FROM_NAME: ${{ variables.email_from_name }}
      EMAIL_SYSTEM_ADDRESS: ${{ variables.email_system_address }}
      EMAIL_SMTP_HOST: ${{ smtp.email.host }}
      EMAIL_SMTP_PORT: ${{ smtp.email.port }}
      EMAIL_SMTP_USER: ${{ smtp.email.username }}
      EMAIL_SMTP_PASSWORD: ${{ smtp.email.password }}
      # Multi-workspace
      IS_MULTIWORKSPACE_ENABLED: ${{ variables.is_multiworkspace_enabled }}
      DEFAULT_SUBDOMAIN: ${{ variables.default_subdomain }}
      # Serverless/Logic Functions
      SERVERLESS_TYPE: ${{ variables.serverless_type }}
    cpu: "1"
    memory: "2Gi"
    replicas: 1

# Services
services:
  server:
    deployment: server
    port: ${{ ports.server.port }}
    protocol: http

# Routes for external access
routes:
  public:
    type: http
    service: server
