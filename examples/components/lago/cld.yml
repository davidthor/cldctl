# Lago - Open Source Billing Platform
# https://www.getlago.com/docs/guide/lago-self-hosted/docker
#
# This component deploys Lago using the official Docker images from Docker Hub.
# Lago is a usage-based billing platform with support for subscriptions,
# metering, invoicing, and more.

variables:
  # Application URLs
  lago_front_url:
    description: "Public URL of the Lago front-end application (used for CORS)"
    default: "http://localhost"

  lago_api_url:
    description: "Public URL of the Lago API"
    default: "http://localhost:3000"

  # Email sender address (application-controlled)
  lago_from_email:
    description: "Email address for outgoing emails (e.g., noreply@example.com)"
    default: ""

  # Optional: Google SSO
  google_auth_client_id:
    description: "Google OAuth client ID for SSO"
    default: ""

  google_auth_client_secret:
    description: "Google OAuth client secret for SSO"
    sensitive: true
    default: ""

  # Feature flags
  lago_disable_signup:
    description: "Disable new user signups"
    default: "false"

  lago_sidekiq_web:
    description: "Enable Sidekiq web UI for job monitoring"
    default: "false"

  # Database settings
  database_pool:
    description: "Max database connections per instance"
    default: "10"

  # Webhook settings
  lago_webhook_attempts:
    description: "Number of retry attempts for failed webhooks"
    default: "3"

# Encryption Keys - automatically generated by the datacenter
encryptionKeys:
  # RSA key for webhook signatures
  rsa-key:
    type: rsa
    bits: 2048

  # Session encryption key (64 bytes = 512 bits for hex encoding)
  secret-key-base:
    type: symmetric
    bytes: 64

  # Primary encryption key for sensitive data
  encryption-primary:
    type: symmetric
    bytes: 32

  # Deterministic encryption key for sensitive data
  encryption-deterministic:
    type: symmetric
    bytes: 32

  # Key derivation salt (uses symmetric type)
  encryption-salt:
    type: symmetric
    bytes: 32

# SMTP - Email sending configuration
# The datacenter provisions SMTP credentials automatically
smtp:
  email: {}

# Databases
databases:
  postgres:
    type: postgres:^15

  redis:
    type: redis:^7

# Deployments
deployments:
  # Front-end application
  front:
    image: getlago/front:v1.21.2
    environment:
      API_URL: ${{ variables.lago_api_url }}
      APP_ENV: production
      LAGO_DISABLE_SIGNUP: ${{ variables.lago_disable_signup }}
      LAGO_OAUTH_PROVIDERS: ${{ variables.google_auth_client_id }}
      SENTRY_DSN: ""
    cpu: "0.5"
    memory: "512Mi"
    replicas: 1
    liveness_probe:
      path: /
      port: 80
      initial_delay_seconds: 10

  # API backend
  api:
    image: getlago/api:v1.21.2
    command: ["./scripts/start.sh"]
    environment:
      RAILS_ENV: production
      LAGO_RAILS_STDOUT: "true"
      # Database
      DATABASE_URL: ${{ databases.postgres.url }}
      DATABASE_POOL: ${{ variables.database_pool }}
      DATABASE_PREPARED_STATEMENTS: "true"
      # Redis
      REDIS_URL: ${{ databases.redis.url }}
      LAGO_REDIS_CACHE_URL: ${{ databases.redis.url }}
      LAGO_REDIS_CACHE_POOL_SIZE: "5"
      # URLs
      LAGO_FRONT_URL: ${{ variables.lago_front_url }}
      LAGO_API_URL: ${{ variables.lago_api_url }}
      # Security - using auto-generated encryption keys
      SECRET_KEY_BASE: ${{ encryptionKeys.secret-key-base.key }}
      LAGO_RSA_PRIVATE_KEY: ${{ encryptionKeys.rsa-key.privateKeyBase64 }}
      LAGO_ENCRYPTION_PRIMARY_KEY: ${{ encryptionKeys.encryption-primary.keyBase64 }}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${{ encryptionKeys.encryption-deterministic.keyBase64 }}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${{ encryptionKeys.encryption-salt.keyBase64 }}
      # PDF Service
      LAGO_PDF_URL: ${{ services.pdf.url }}
      # Email - using datacenter-provisioned SMTP
      LAGO_FROM_EMAIL: ${{ variables.lago_from_email }}
      LAGO_SMTP_ADDRESS: ${{ smtp.email.host }}
      LAGO_SMTP_PORT: ${{ smtp.email.port }}
      LAGO_SMTP_USERNAME: ${{ smtp.email.username }}
      LAGO_SMTP_PASSWORD: ${{ smtp.email.password }}
      # Google SSO (optional)
      GOOGLE_AUTH_CLIENT_ID: ${{ variables.google_auth_client_id }}
      GOOGLE_AUTH_CLIENT_SECRET: ${{ variables.google_auth_client_secret }}
      # Features
      LAGO_DISABLE_SIGNUP: ${{ variables.lago_disable_signup }}
      LAGO_SIDEKIQ_WEB: ${{ variables.lago_sidekiq_web }}
      LAGO_WEBHOOK_ATTEMPTS: ${{ variables.lago_webhook_attempts }}
      # Disable features not needed in basic setup
      LAGO_DISABLE_WALLET_REFRESH: "false"
    cpu: "1"
    memory: "1Gi"
    replicas: 1
    liveness_probe:
      path: /health
      port: 3000
      initial_delay_seconds: 30
    readiness_probe:
      path: /health
      port: 3000
      initial_delay_seconds: 15

  # Async worker for background jobs
  api-worker:
    image: getlago/api:v1.21.2
    command: ["./scripts/start.worker.sh"]
    environment:
      RAILS_ENV: production
      LAGO_RAILS_STDOUT: "true"
      # Database
      DATABASE_URL: ${{ databases.postgres.url }}
      DATABASE_POOL: ${{ variables.database_pool }}
      DATABASE_PREPARED_STATEMENTS: "true"
      # Redis
      REDIS_URL: ${{ databases.redis.url }}
      LAGO_REDIS_CACHE_URL: ${{ databases.redis.url }}
      LAGO_REDIS_CACHE_POOL_SIZE: "5"
      # URLs
      LAGO_FRONT_URL: ${{ variables.lago_front_url }}
      LAGO_API_URL: ${{ variables.lago_api_url }}
      # Security - using auto-generated encryption keys
      SECRET_KEY_BASE: ${{ encryptionKeys.secret-key-base.key }}
      LAGO_RSA_PRIVATE_KEY: ${{ encryptionKeys.rsa-key.privateKeyBase64 }}
      LAGO_ENCRYPTION_PRIMARY_KEY: ${{ encryptionKeys.encryption-primary.keyBase64 }}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${{ encryptionKeys.encryption-deterministic.keyBase64 }}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${{ encryptionKeys.encryption-salt.keyBase64 }}
      # PDF Service
      LAGO_PDF_URL: ${{ services.pdf.url }}
      # Email - using datacenter-provisioned SMTP
      LAGO_FROM_EMAIL: ${{ variables.lago_from_email }}
      LAGO_SMTP_ADDRESS: ${{ smtp.email.host }}
      LAGO_SMTP_PORT: ${{ smtp.email.port }}
      LAGO_SMTP_USERNAME: ${{ smtp.email.username }}
      LAGO_SMTP_PASSWORD: ${{ smtp.email.password }}
      # Features
      LAGO_WEBHOOK_ATTEMPTS: ${{ variables.lago_webhook_attempts }}
    cpu: "1"
    memory: "1Gi"
    replicas: 1

  # Clock worker for scheduled tasks
  api-clock:
    image: getlago/api:v1.21.2
    command: ["./scripts/start.clock.sh"]
    environment:
      RAILS_ENV: production
      LAGO_RAILS_STDOUT: "true"
      # Database
      DATABASE_URL: ${{ databases.postgres.url }}
      DATABASE_POOL: ${{ variables.database_pool }}
      DATABASE_PREPARED_STATEMENTS: "true"
      # Redis
      REDIS_URL: ${{ databases.redis.url }}
      LAGO_REDIS_CACHE_URL: ${{ databases.redis.url }}
      LAGO_REDIS_CACHE_POOL_SIZE: "5"
      # URLs
      LAGO_FRONT_URL: ${{ variables.lago_front_url }}
      LAGO_API_URL: ${{ variables.lago_api_url }}
      # Security - using auto-generated encryption keys
      SECRET_KEY_BASE: ${{ encryptionKeys.secret-key-base.key }}
      LAGO_RSA_PRIVATE_KEY: ${{ encryptionKeys.rsa-key.privateKeyBase64 }}
      LAGO_ENCRYPTION_PRIMARY_KEY: ${{ encryptionKeys.encryption-primary.keyBase64 }}
      LAGO_ENCRYPTION_DETERMINISTIC_KEY: ${{ encryptionKeys.encryption-deterministic.keyBase64 }}
      LAGO_ENCRYPTION_KEY_DERIVATION_SALT: ${{ encryptionKeys.encryption-salt.keyBase64 }}
      # Features
      LAGO_WEBHOOK_ATTEMPTS: ${{ variables.lago_webhook_attempts }}
    cpu: "0.5"
    memory: "512Mi"
    replicas: 1

  # PDF generation service (Gotenberg)
  pdf:
    image: gotenberg/gotenberg:8
    command:
      - "gotenberg"
      - "--api-port=3000"
      - "--api-timeout=30s"
      - "--log-level=warn"
    cpu: "0.5"
    memory: "512Mi"
    replicas: 1
    liveness_probe:
      path: /health
      port: 3000
      initial_delay_seconds: 10

# Services
services:
  front:
    deployment: front
    port: 80
    protocol: http

  api:
    deployment: api
    port: 3000
    protocol: http

  pdf:
    deployment: pdf
    port: 3000
    protocol: http

# Routes for external access
routes:
  public:
    type: http
    rules:
      # API routes
      - name: api
        matches:
          - path:
              type: PathPrefix
              value: /api
        backendRefs:
          - service: api
        filters:
          - type: URLRewrite
            urlRewrite:
              path:
                type: ReplacePrefixMatch
                replacePrefixMatch: /api
        timeouts:
          request: 60s
          backendRequest: 55s

      # GraphQL endpoint
      - name: graphql
        matches:
          - path:
              type: Exact
              value: /graphql
        backendRefs:
          - service: api
        timeouts:
          request: 60s

      # Webhooks endpoint
      - name: webhooks
        matches:
          - path:
              type: PathPrefix
              value: /webhooks
        backendRefs:
          - service: api

      # Health check
      - name: health
        matches:
          - path:
              type: Exact
              value: /health
        backendRefs:
          - service: api

      # Front-end (catch-all for UI)
      - name: frontend
        matches:
          - path:
              type: PathPrefix
              value: /
        backendRefs:
          - service: front
