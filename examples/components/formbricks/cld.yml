# Formbricks - Open Source Survey Platform
# https://formbricks.com/docs/self-hosting/overview
#
# This component deploys Formbricks using the official Docker image.
# Formbricks is an open-source Experience Management platform and
# Qualtrics/Typeform alternative for collecting user feedback.

variables:
  # Logging
  log_level:
    description: "Minimum log level (debug, info, warn, error, fatal)"
    default: "info"

  # Feature flags
  email_auth_disabled:
    description: "Disable email/password authentication (1 to disable)"
    default: "0"

  email_verification_disabled:
    description: "Disable email verification for new accounts (1 to disable)"
    default: "0"

  password_reset_disabled:
    description: "Disable password reset functionality (1 to disable)"
    default: "0"

  invite_disabled:
    description: "Disable user invitations (1 to disable)"
    default: "0"

  rate_limiting_disabled:
    description: "Disable rate limiting (1 to disable)"
    default: "0"

  # Branding
  default_brand_color:
    description: "Default brand color for surveys (hex color)"
    default: "#64748b"

  # Privacy and legal
  privacy_url:
    description: "URL to privacy policy page"
    default: ""

  terms_url:
    description: "URL to terms of service page"
    default: ""

  imprint_url:
    description: "URL to imprint/legal notice page"
    default: ""

  # Session settings
  session_max_age:
    description: "Maximum session age in seconds"
    default: "86400"

  # Audit logging
  audit_log_enabled:
    description: "Enable audit logging (requires Redis)"
    default: "0"

  # Google OAuth (optional)
  google_client_id:
    description: "Google OAuth client ID for SSO"
    default: ""

  google_client_secret:
    description: "Google OAuth client secret for SSO"
    sensitive: true
    default: ""

  # GitHub OAuth (optional)
  github_id:
    description: "GitHub OAuth client ID for SSO"
    default: ""

  github_secret:
    description: "GitHub OAuth client secret for SSO"
    sensitive: true
    default: ""

  # Email sender address (application-controlled)
  mail_from:
    description: "Email address for outgoing emails (e.g., noreply@formbricks.com)"
    default: "noreply@formbricks.local"

# Encryption Keys - automatically generated by the datacenter
encryptionKeys:
  # NextAuth secret for session signing (32 bytes hex = 64 characters)
  nextauth-secret:
    type: symmetric
    bytes: 32

  # Encryption key for data encryption and audit log hashing (32 bytes)
  encryption-key:
    type: symmetric
    bytes: 32

  # Cron secret for securing cron job API endpoints (32 bytes)
  cron-secret:
    type: symmetric
    bytes: 32

# SMTP - Email sending configuration
# The datacenter provisions SMTP credentials automatically
smtp:
  email: {}

# S3-compatible bucket for file uploads (optional)
buckets:
  uploads:
    region: us-east-1

# Databases
databases:
  postgres:
    type: postgres:^15

  redis:
    type: redis:^7

# Deployments
deployments:
  # Main Formbricks application (Next.js)
  app:
    image: ghcr.io/formbricks/formbricks:v3.6.1
    environment:
      # Application URLs (dynamically injected from route)
      WEBAPP_URL: ${{ routes.public.url }}
      NEXTAUTH_URL: ${{ routes.public.url }}
      PUBLIC_URL: ${{ routes.public.url }}
      # Database connections
      DATABASE_URL: ${{ databases.postgres.url }}
      REDIS_URL: ${{ databases.redis.url }}
      # Security - auto-generated encryption keys (hex-encoded)
      NEXTAUTH_SECRET: ${{ encryptionKeys.nextauth-secret.key }}
      ENCRYPTION_KEY: ${{ encryptionKeys.encryption-key.key }}
      CRON_SECRET: ${{ encryptionKeys.cron-secret.key }}
      # S3/MinIO file storage
      S3_ACCESS_KEY: ${{ buckets.uploads.accessKeyId }}
      S3_SECRET_KEY: ${{ buckets.uploads.secretAccessKey }}
      S3_BUCKET_NAME: ${{ buckets.uploads.bucket }}
      S3_ENDPOINT_URL: ${{ buckets.uploads.endpoint }}
      S3_REGION: us-east-1
      S3_FORCE_PATH_STYLE: "1"
      # Email configuration
      MAIL_FROM: ${{ variables.mail_from }}
      SMTP_HOST: ${{ smtp.email.host }}
      SMTP_PORT: ${{ smtp.email.port }}
      SMTP_USER: ${{ smtp.email.username }}
      SMTP_PASSWORD: ${{ smtp.email.password }}
      SMTP_SECURE_ENABLED: "1"
      # Logging
      LOG_LEVEL: ${{ variables.log_level }}
      # Feature flags
      EMAIL_AUTH_DISABLED: ${{ variables.email_auth_disabled }}
      EMAIL_VERIFICATION_DISABLED: ${{ variables.email_verification_disabled }}
      PASSWORD_RESET_DISABLED: ${{ variables.password_reset_disabled }}
      INVITE_DISABLED: ${{ variables.invite_disabled }}
      RATE_LIMITING_DISABLED: ${{ variables.rate_limiting_disabled }}
      # Branding
      DEFAULT_BRAND_COLOR: ${{ variables.default_brand_color }}
      # Privacy and legal
      PRIVACY_URL: ${{ variables.privacy_url }}
      TERMS_URL: ${{ variables.terms_url }}
      IMPRINT_URL: ${{ variables.imprint_url }}
      # Session settings
      SESSION_MAX_AGE: ${{ variables.session_max_age }}
      # Audit logging
      AUDIT_LOG_ENABLED: ${{ variables.audit_log_enabled }}
      # Google OAuth (optional)
      GOOGLE_CLIENT_ID: ${{ variables.google_client_id }}
      GOOGLE_CLIENT_SECRET: ${{ variables.google_client_secret }}
      # GitHub OAuth (optional)
      GITHUB_ID: ${{ variables.github_id }}
      GITHUB_SECRET: ${{ variables.github_secret }}
    cpu: "1"
    memory: "2Gi"
    replicas: 1
    liveness_probe:
      path: /health
      port: 3000
      initial_delay_seconds: 30
    readiness_probe:
      path: /health
      port: 3000
      initial_delay_seconds: 15

# Services
services:
  app:
    deployment: app
    port: 3000
    protocol: http

# Routes for external access
routes:
  public:
    type: http
    rules:
      # Main application (UI, API, surveys)
      - name: app
        matches:
          - path:
              type: PathPrefix
              value: /
        backendRefs:
          - service: app
        timeouts:
          request: 60s
          backendRequest: 55s
