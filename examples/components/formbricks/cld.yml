# Formbricks - Open Source Survey Platform
# https://formbricks.com/docs/self-hosting/overview
#
# This component deploys Formbricks using the official Docker image.
# Formbricks is an open-source Experience Management platform and
# Qualtrics/Typeform alternative for collecting user feedback.

variables:
  # Logging
  log_level:
    description: "Minimum log level (debug, info, warn, error, fatal)"
    default: "info"

  # Feature flags
  email_verification_disabled:
    description: "Disable email verification for new accounts (1 to disable)"
    default: "1"

  password_reset_disabled:
    description: "Disable password reset functionality (1 to disable)"
    default: "1"

  # Email sender configuration
  mail_from:
    description: "Email address for outgoing emails (e.g., noreply@formbricks.com)"
    default: "noreply@formbricks.local"

  mail_from_name:
    description: "Display name for outgoing emails"
    default: "Formbricks"

# Encryption Keys - automatically generated by the datacenter
encryptionKeys:
  # NextAuth secret for session signing (32 bytes hex = 64 characters)
  nextauth-secret:
    type: symmetric
    bytes: 32

  # Encryption key for data encryption and audit log hashing (32 bytes)
  encryption-key:
    type: symmetric
    bytes: 32

  # Cron secret for securing cron job API endpoints (32 bytes)
  cron-secret:
    type: symmetric
    bytes: 32

# SMTP - Email sending configuration
# The datacenter provisions SMTP credentials automatically
smtp:
  email: {}

# Observability - OpenTelemetry configuration
# Auto-inject mode sets OTEL_* env vars on all workloads automatically
observability:
  inject: true

buckets:
  uploads:
    type: s3
    description: Storage bucket for file uploads

# Databases
databases:
  postgres:
    type: postgres:^15
    migrations:
      image: ghcr.io/formbricks/formbricks:4.6.1
      command:
        - sh
        - -c
        - |
          set -e
          echo "Running Prisma migrations..."
          node packages/database/dist/scripts/apply-migrations.js
          echo "Running SAML database setup..."
          node packages/database/dist/scripts/create-saml-database.js
          echo "Database setup complete."
      environment:
        DATABASE_URL: ${{ databases.postgres.url }}

  redis:
    type: redis:^7

# Deployments
deployments:
  # Main Formbricks application (Next.js)
  app:
    image: ghcr.io/formbricks/formbricks:4.6.1
    command: ["node", "apps/web/server.js"]
    environment:
      # Application URLs (dynamically injected from route)
      WEBAPP_URL: ${{ routes.public.url }}
      NEXTAUTH_URL: ${{ routes.public.url }}
      # Database connections
      DATABASE_URL: ${{ databases.postgres.url }}
      REDIS_URL: ${{ databases.redis.url }}
      # Security - auto-generated encryption keys (hex-encoded)
      NEXTAUTH_SECRET: ${{ encryptionKeys.nextauth-secret.key }}
      ENCRYPTION_KEY: ${{ encryptionKeys.encryption-key.key }}
      CRON_SECRET: ${{ encryptionKeys.cron-secret.key }}
      # S3/MinIO file storage
      S3_ACCESS_KEY: ${{ buckets.uploads.accessKeyId }}
      S3_SECRET_KEY: ${{ buckets.uploads.secretAccessKey }}
      S3_BUCKET_NAME: ${{ buckets.uploads.bucket }}
      S3_ENDPOINT_URL: ${{ buckets.uploads.endpoint }}
      S3_REGION: ${{ buckets.uploads.region }}
      S3_FORCE_PATH_STYLE: "1"
      # Email configuration
      MAIL_FROM: ${{ variables.mail_from }}
      MAIL_FROM_NAME: ${{ variables.mail_from_name }}
      SMTP_HOST: ${{ smtp.email.host }}
      SMTP_PORT: ${{ smtp.email.port }}
      SMTP_USER: ${{ smtp.email.username | default "unused" }}
      SMTP_PASSWORD: ${{ smtp.email.password | default "unused" }}
      SMTP_SECURE_ENABLED: "0"
      SMTP_AUTHENTICATED: "0"
      # Logging
      LOG_LEVEL: ${{ variables.log_level }}
      # Feature flags
      EMAIL_VERIFICATION_DISABLED: ${{ variables.email_verification_disabled }}
      PASSWORD_RESET_DISABLED: ${{ variables.password_reset_disabled }}
    cpu: "1"
    memory: "2Gi"
    replicas: 1
    liveness_probe:
      path: /health
      port: 3000
      failure_threshold: 10
    readiness_probe:
      path: /health
      port: 3000

# Services
services:
  app:
    deployment: app
    port: 3000
    protocol: http

# Routes for external access
routes:
  public:
    type: http
    service: app
