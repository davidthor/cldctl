# SigNoz - Open Source Observability Platform
# https://signoz.io/docs/install/docker/
#
# This component deploys SigNoz using the official Docker images.
# SigNoz is an open-source APM and observability platform that provides
# logs, metrics, and traces in a single pane of glass.

variables:
  # Data retention settings
  retention_period_logs:
    description: "Retention period for logs in days"
    default: "7"

  retention_period_traces:
    description: "Retention period for traces in days"
    default: "7"

  retention_period_metrics:
    description: "Retention period for metrics in days"
    default: "30"

  # ClickHouse settings
  clickhouse_cluster:
    description: "ClickHouse cluster name"
    default: "cluster"

  clickhouse_replication:
    description: "Enable ClickHouse replication (requires multiple ClickHouse nodes)"
    default: "false"

  # Query Service settings
  query_service_log_level:
    description: "Log level for query service (debug, info, warn, error)"
    default: "info"

  # OTEL Collector settings
  otel_collector_log_level:
    description: "Log level for OTEL collector (debug, info, warn, error)"
    default: "info"

  # Feature flags
  enable_query_service_api_key:
    description: "Enable API key authentication for query service"
    default: "false"

  # Alert Manager settings
  alertmanager_enabled:
    description: "Enable built-in alert manager"
    default: "true"

# Dependencies
# Dependencies are repo:tag references. Tag is optional and supports semver (e.g., "^1", "~2.0").
dependencies:
  # ZooKeeper is required for ClickHouse distributed coordination
  zookeeper: ghcr.io/cldcvr/zookeeper

# Databases
databases:
  # ClickHouse - Time-series database for storing telemetry data
  clickhouse:
    type: clickhouse:^24

# Deployments
deployments:
  # SigNoz Query Service - Main UI and API backend
  query-service:
    image: signoz/signoz:0.69.0
    command:
      - "./query-service"
      - "--config=/root/config/prometheus.yml"
    environment:
      # ClickHouse connection
      ClickHouseUrl: tcp://${{ databases.clickhouse.host }}:${{ databases.clickhouse.port }}
      CLICKHOUSE_HOST: ${{ databases.clickhouse.host }}
      CLICKHOUSE_PORT: ${{ databases.clickhouse.port }}
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_USER: ${{ databases.clickhouse.username }}
      CLICKHOUSE_PASSWORD: ${{ databases.clickhouse.password }}
      CLICKHOUSE_DATABASE: ${{ databases.clickhouse.database }}
      CLICKHOUSE_CLUSTER: ${{ variables.clickhouse_cluster }}
      # ZooKeeper connection
      ZOOKEEPER_HOST: ${{ dependencies.zookeeper.services.zookeeper.host }}
      ZOOKEEPER_PORT: ${{ dependencies.zookeeper.services.zookeeper.port }}
      # Query service configuration
      SIGNOZ_LOCAL_DB_PATH: /var/lib/signoz/signoz.db
      STORAGE: clickhouse
      GODEBUG: netdns=go
      TELEMETRY_ENABLED: "true"
      DEPLOYMENT_TYPE: docker-standalone
      # Alert Manager
      ALERTMANAGER_API_PREFIX: http://localhost:9093/api/
      # Logging
      LOG_LEVEL: ${{ variables.query_service_log_level }}
    cpu: "1"
    memory: "2Gi"
    replicas: 1
    liveness_probe:
      path: /api/v1/health
      port: 8080
      initial_delay_seconds: 30
    readiness_probe:
      path: /api/v1/health
      port: 8080
      initial_delay_seconds: 15

  # SigNoz OpenTelemetry Collector - Receives and processes telemetry data
  otel-collector:
    image: signoz/signoz-otel-collector:0.111.24
    command:
      - "/signoz-collector"
      - "--config=/etc/otel-collector-config.yaml"
    environment:
      # ClickHouse connection
      CLICKHOUSE_HOST: ${{ databases.clickhouse.host }}
      CLICKHOUSE_PORT: ${{ databases.clickhouse.port }}
      CLICKHOUSE_HTTP_PORT: "8123"
      CLICKHOUSE_USER: ${{ databases.clickhouse.username }}
      CLICKHOUSE_PASSWORD: ${{ databases.clickhouse.password }}
      CLICKHOUSE_DATABASE: ${{ databases.clickhouse.database }}
      CLICKHOUSE_CLUSTER: ${{ variables.clickhouse_cluster }}
      CLICKHOUSE_REPLICATION: ${{ variables.clickhouse_replication }}
      # ZooKeeper connection
      ZOOKEEPER_HOST: ${{ dependencies.zookeeper.services.zookeeper.host }}
      ZOOKEEPER_PORT: ${{ dependencies.zookeeper.services.zookeeper.port }}
      # OTEL Collector configuration
      OTEL_RESOURCE_ATTRIBUTES: host.name=signoz-otel-collector
      LOW_CARDINAL_EXCEPTION_GROUPING: "false"
      # Logging
      SIGNOZ_COMPONENT: otel-collector
    cpu: "1"
    memory: "2Gi"
    replicas: 1
    liveness_probe:
      path: /
      port: 13133
      initial_delay_seconds: 30

# Services
services:
  query-service:
    deployment: query-service
    port: 8080
    protocol: http

  # OTLP gRPC endpoint - for application instrumentation
  otel-grpc:
    deployment: otel-collector
    port: 4317
    protocol: grpc

  # OTLP HTTP endpoint - for application instrumentation
  otel-http:
    deployment: otel-collector
    port: 4318
    protocol: http

# Routes for external access
routes:
  public:
    type: http
    rules:
      # SigNoz UI and API
      - name: ui
        matches:
          - path:
              type: PathPrefix
              value: /
        backendRefs:
          - service: query-service

  # OTLP ingestion endpoints (separate route for telemetry data)
  otlp:
    type: http
    rules:
      # OTLP HTTP endpoint for trace/metric/log ingestion
      - name: otlp-http
        matches:
          - path:
              type: PathPrefix
              value: /v1
        backendRefs:
          - service: otel-http
        timeouts:
          request: 30s
