---
title: "Serverless with Neon & Cloudflare"
description: "Build a fully serverless datacenter with Neon, Upstash, and Cloudflare"
---

# Serverless Datacenter

This guide shows how to build a fully serverless datacenter using Neon for PostgreSQL, Upstash for Redis, and Cloudflare Workers for compute.

<Info>
Example source: `examples/datacenters/serverless-neon/`
</Info>

## Overview

This datacenter provides:
- **Compute**: Cloudflare Workers (edge functions)
- **Databases**: Neon PostgreSQL (serverless), Upstash Redis
- **Storage**: Cloudflare R2 (S3-compatible)
- **Networking**: Cloudflare CDN and DNS

## Why Serverless?

- **Scale to zero**: Pay only for what you use
- **No servers to manage**: Fully managed infrastructure
- **Global edge deployment**: Low latency worldwide
- **Instant branches**: Neon creates database branches instantly

## Configuration Variables

```hcl
variable "neon_api_key" {
  description = "Neon API key"
  type        = string
  sensitive   = true
}

variable "neon_project_id" {
  description = "Neon project ID"
  type        = string
}

variable "upstash_email" {
  description = "Upstash account email"
  type        = string
}

variable "upstash_api_key" {
  description = "Upstash API key"
  type        = string
  sensitive   = true
}

variable "cloudflare_account_id" {
  description = "Cloudflare account ID"
  type        = string
}

variable "cloudflare_api_token" {
  description = "Cloudflare API token"
  type        = string
  sensitive   = true
}

variable "domain" {
  description = "Base domain for environments"
  type        = string
}
```

## Environment Configuration

```hcl
environment {
  # Neon branch per environment (instant, zero-cost when idle)
  module "neon_branch" {
    when  = anytrue([for n in environment.nodes : element(split(":", n.inputs.type), 0) == "postgres" if n.type == "database"])
    build = "./modules/neon-branch"
    inputs = {
      project_id  = variable.neon_project_id
      branch_name = environment.name
      api_key     = variable.neon_api_key
    }
  }

  # Upstash Redis per environment
  module "upstash_redis" {
    when  = anytrue([for n in environment.nodes : element(split(":", n.inputs.type), 0) == "redis" if n.type == "database"])
    build = "./modules/upstash-redis"
    inputs = {
      name    = environment.name
      region  = "us-east-1"
      email   = variable.upstash_email
      api_key = variable.upstash_api_key
    }
  }

  # Cloudflare Workers namespace
  module "cf_namespace" {
    build = "./modules/cf-workers-namespace"
    inputs = {
      name       = environment.name
      account_id = variable.cloudflare_account_id
      api_token  = variable.cloudflare_api_token
    }
  }
}
```

## Resource Hooks

### Database Hook (Neon/Upstash)

```hcl
# PostgreSQL via Neon
database {
  when = element(split(":", node.inputs.type), 0) == "postgres"

  module "neon_database" {
    build = "./modules/neon-database"
    inputs = {
      name            = node.name
      environment     = environment.name
      neon_project_id = variable.neon_project_id
      neon_branch_id  = module.neon_branch.branch_id
      neon_api_key    = variable.neon_api_key
    }
  }

  outputs = {
    host     = module.neon_database.host
    port     = module.neon_database.port
    database = module.neon_database.database
    url      = module.neon_database.url
  }
}

# Redis via Upstash
database {
  when = element(split(":", node.inputs.type), 0) == "redis"

  module "redis_database" {
    build = "./modules/upstash-database"
    inputs = {
      name                = node.name
      upstash_database_id = module.upstash_redis.database_id
      upstash_api_key     = variable.upstash_api_key
    }
  }

  outputs = {
    host = module.redis_database.host
    port = module.redis_database.port
    url  = module.redis_database.url
  }
}
```

### Deployment/Function Hook (Cloudflare Workers)

```hcl
deployment {
  module "worker" {
    build = "./modules/cf-worker"
    inputs = {
      name        = node.name
      namespace   = environment.name
      image       = node.inputs.image
      environment = node.inputs.environment
      account_id  = variable.cloudflare_account_id
      api_token   = variable.cloudflare_api_token
    }
  }

  outputs = {
    id = module.worker.worker_id
  }
}

function {
  module "cf_function" {
    build = "./modules/cf-worker"
    inputs = {
      name        = node.name
      namespace   = environment.name
      image       = node.inputs.image
      framework   = node.inputs.framework
      environment = node.inputs.environment
      account_id  = variable.cloudflare_account_id
      api_token   = variable.cloudflare_api_token
    }
  }

  outputs = {
    id       = module.cf_function.worker_id
    endpoint = module.cf_function.url
  }
}
```

### Bucket Hook (R2)

```hcl
bucket {
  module "r2_bucket" {
    build = "./modules/cloudflare-r2"
    inputs = {
      name       = "${environment.name}-${node.name}"
      account_id = variable.cloudflare_account_id
      api_token  = variable.cloudflare_api_token
      versioning = node.inputs.versioning
      public     = node.inputs.public
    }
  }

  outputs = {
    endpoint        = module.r2_bucket.endpoint
    bucket          = module.r2_bucket.bucket_name
    region          = "auto"
    accessKeyId     = module.r2_bucket.access_key_id
    secretAccessKey = module.r2_bucket.secret_access_key
  }
}
```

## Key Benefits

### Instant Database Branches

Neon creates database branches instantly:

```hcl
module "neon_branch" {
  inputs = {
    project_id  = variable.neon_project_id
    branch_name = environment.name  # e.g., "preview-123"
  }
}
```

Each preview environment gets its own database branch with:
- Instant creation (seconds, not minutes)
- Copy-on-write from production data
- Zero cost when idle

### Global Edge Deployment

Cloudflare Workers run at the edge:
- 300+ locations worldwide
- Sub-10ms latency to users
- Automatic scaling

### Pay-Per-Use Pricing

- Neon: Free tier, then $0.09/GB/month
- Upstash: Free tier, then $0.2/100K requests
- Workers: Free tier, then $0.50/million requests
- R2: Free tier, then $0.015/GB/month

## Deploying

```bash
# Build and deploy datacenter
arcctl dc build . -t ghcr.io/myorg/serverless-dc:v1.0.0
arcctl dc push ghcr.io/myorg/serverless-dc:v1.0.0

arcctl dc deploy serverless-prod \
  --config ghcr.io/myorg/serverless-dc:v1.0.0 \
  --var neon_api_key=$NEON_API_KEY \
  --var neon_project_id=$NEON_PROJECT_ID \
  --var upstash_api_key=$UPSTASH_API_KEY \
  --var cloudflare_account_id=$CF_ACCOUNT_ID \
  --var cloudflare_api_token=$CF_API_TOKEN \
  --var domain=app.example.com

# Create environment (instant!)
arcctl env create preview-123 --datacenter serverless-prod
```

## Ideal Use Cases

- Preview environments (instant creation, zero cost when idle)
- Edge applications (global low latency)
- Variable traffic (scale to zero)
- Cost-sensitive deployments

## Related Guides

<CardGroup cols={2}>
  <Card title="Vercel Functions" href="/guides/datacenters/vercel-functions">
    Alternative serverless platform
  </Card>
  <Card title="Next.js App" href="/guides/components/nextjs-app">
    Deploy Next.js serverless
  </Card>
</CardGroup>
