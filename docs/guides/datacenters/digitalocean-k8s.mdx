---
title: "DigitalOcean Kubernetes"
description: "Deploy to DigitalOcean Kubernetes with managed databases"
---

# DigitalOcean Kubernetes Datacenter

This guide shows how to build a datacenter that deploys components to DigitalOcean Kubernetes (DOKS) with managed databases and Spaces for storage.

<Info>
Example source: `examples/datacenters/digitalocean-k8s/`
</Info>

## Overview

This datacenter provides:
- **Compute**: DigitalOcean Kubernetes (DOKS)
- **Databases**: Managed PostgreSQL, MySQL, Redis
- **Storage**: DigitalOcean Spaces (S3-compatible)
- **Functions**: Knative Serving (serverless on K8s)
- **Networking**: NGINX Ingress, cert-manager

## Configuration Variables

```hcl
variable "do_token" {
  description = "DigitalOcean API token"
  type        = string
  sensitive   = true
}

variable "region" {
  description = "DigitalOcean region"
  type        = string
  default     = "nyc3"
}

variable "cluster_name" {
  description = "Kubernetes cluster name"
  type        = string
}

variable "domain" {
  description = "Base domain for environments"
  type        = string
}

variable "registry" {
  description = "Container registry URL"
  type        = string
  default     = "registry.digitalocean.com"
}
```

## Shared Infrastructure

```hcl
# DOKS Cluster with autoscaling
module "k8s" {
  build = "./modules/doks-cluster"
  inputs = {
    name   = variable.cluster_name
    region = variable.region
    token  = variable.do_token
    node_pool = {
      size       = "s-2vcpu-4gb"
      min_nodes  = 2
      max_nodes  = 10
      auto_scale = true
    }
  }
}
```

## Environment Configuration

```hcl
environment {
  # Kubernetes namespace per environment
  module "namespace" {
    build = "./modules/k8s-namespace"
    inputs = {
      name       = environment.name
      kubeconfig = module.k8s.kubeconfig
    }
  }

  # Gateway for HTTP routes (only when routes exist)
  module "gateway" {
    when  = contains(environment.nodes.*.type, "ingress")
    build = "./modules/k8s-gateway"
    inputs = {
      name          = "${environment.name}-gateway"
      namespace     = environment.name
      gateway_class = "nginx"
      kubeconfig    = module.k8s.kubeconfig
      tls = {
        enabled = true
        issuer  = "letsencrypt-prod"
      }
    }
  }

  # DNS records
  module "dns_records" {
    build = "./modules/do-dns"
    inputs = {
      domain    = variable.domain
      subdomain = environment.name
      target    = module.k8s.load_balancer_ip
      token     = variable.do_token
    }
  }
}
```

## Resource Hooks

### Database Hook (Managed Database)

```hcl
database {
  module "managed_database" {
    build = "./modules/do-managed-database"
    inputs = {
      name    = "${environment.name}-${node.name}"
      type    = element(split(":", node.inputs.type), 0)
      version = try(element(split(":", node.inputs.type), 1), null)
      region  = variable.region
      size    = "db-s-1vcpu-1gb"
      token   = variable.do_token
    }
  }

  outputs = {
    host     = module.managed_database.host
    port     = module.managed_database.port
    database = module.managed_database.database
    url      = module.managed_database.connection_url
  }
}
```

### Deployment Hook (Kubernetes)

Container-based deployments run on Kubernetes:

```hcl
deployment {
  when = node.inputs.image != null

  module "deployment" {
    build = "./modules/k8s-deployment"
    inputs = merge(node.inputs, {
      namespace  = environment.name
      kubeconfig = module.k8s.kubeconfig
    })
  }

  outputs = {
    id = module.deployment.deployment_id
  }
}
```

### Deployment Hook (Droplet VM)

VM-based deployments use DigitalOcean Droplets for workloads with the `runtime` property:

```hcl
deployment {
  when = node.inputs.runtime != null && node.inputs.image == null

  module "droplet" {
    plugin = "opentofu"
    build  = "./modules/do-droplet"
    inputs = merge(node.inputs, {
      name                = "${environment.name}-${node.component}-${node.name}"
      region              = variable.region
      do_token            = variable.do_token
      ssh_key_fingerprint = variable.ssh_key_fingerprint
    })
  }

  outputs = {
    id = module.droplet.droplet_id
  }
}
```

### Function Hook (Knative)

DigitalOcean doesn't have native functions, so we use Knative:

```hcl
function {
  module "knative_service" {
    build = "./modules/knative-service"
    inputs = merge(node.inputs, {
      namespace  = environment.name
      kubeconfig = module.k8s.kubeconfig
    })
  }

  outputs = {
    id       = module.knative_service.service_id
    endpoint = module.knative_service.url
  }
}
```

### Bucket Hook (Spaces)

```hcl
bucket {
  module "spaces_bucket" {
    build = "./modules/do-spaces"
    inputs = {
      name       = "${environment.name}-${node.name}"
      region     = variable.region
      versioning = node.inputs.versioning
      public     = node.inputs.public
      token      = variable.do_token
    }
  }

  outputs = {
    endpoint        = "https://${variable.region}.digitaloceanspaces.com"
    bucket          = module.spaces_bucket.bucket_name
    region          = variable.region
    accessKeyId     = module.spaces_bucket.access_key
    secretAccessKey = module.spaces_bucket.secret_key
  }
}
```

### Ingress Hook (HTTPRoute)

```hcl
ingress {
  module "httproute" {
    build = "./modules/k8s-httproute"
    inputs = merge(node.inputs, {
      namespace    = environment.name
      gateway_name = "${environment.name}-gateway"
      kubeconfig   = module.k8s.kubeconfig
    })
  }

  outputs = {
    url   = "https://${node.name}.${environment.name}.${variable.domain}"
    hosts = ["${node.name}.${environment.name}.${variable.domain}"]
  }
}
```

## Deploying

```bash
# Build and push
arcctl dc build . -t ghcr.io/myorg/do-k8s-dc:v1.0.0
arcctl dc push ghcr.io/myorg/do-k8s-dc:v1.0.0

# Deploy datacenter
arcctl dc deploy do-production \
  --config ghcr.io/myorg/do-k8s-dc:v1.0.0 \
  --var cluster_name=prod-cluster \
  --var domain=app.example.com \
  --var do_token=$DO_TOKEN

# Create environment and deploy
arcctl env create staging --datacenter do-production
arcctl deploy ghcr.io/myorg/my-app:v1.0.0 -e staging
```

## Cost Optimization

- Use autoscaling with min/max nodes
- Managed databases start at $15/month
- Spaces is cost-effective for storage
- Use smaller droplet sizes for dev environments

## Knative Setup

For serverless functions, install Knative on your cluster:

```bash
kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.12.0/serving-crds.yaml
kubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.12.0/serving-core.yaml
```

## Related Guides

<CardGroup cols={2}>
  <Card title="AWS ECS" href="/guides/datacenters/aws-ecs">
    Alternative AWS deployment
  </Card>
  <Card title="Next.js App" href="/guides/components/nextjs-app">
    Deploy Next.js to DOKS
  </Card>
</CardGroup>
