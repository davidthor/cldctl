---
title: "AWS VMs (EC2)"
description: "VM-based AWS deployment with EC2 instances, RDS, S3, and SES"
---

# AWS VMs (EC2) Datacenter

This guide shows how to build a datacenter that deploys all workloads to EC2 instances. Container-based deployments install Docker on EC2, runtime-based deployments install the language runtime directly, and functions run as long-lived processes behind ALB.

<Info>
This is an officially maintained datacenter template. Source: [`official-templates/aws-vms/`](https://github.com/davidthor/cldctl/tree/main/official-templates/aws-vms)
</Info>

## Overview

This datacenter provides:
- **Compute**: EC2 instances for ALL deployments and functions
- **Databases**: RDS for PostgreSQL/MySQL, ElastiCache for Redis
- **Storage**: S3 buckets
- **Encryption**: KMS (symmetric), Secrets Manager (asymmetric key pairs)
- **Email**: AWS SES (SMTP)
- **Routing**: ALB + Route53
- **Observability**: CloudWatch agent on EC2

All EC2 provisioning uses `plugin = "opentofu"` for infrastructure management.

## Configuration Variables

```hcl
variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "us-east-1"
}

variable "vpc_id" {
  description = "VPC ID for deployment"
  type        = string
}

variable "domain" {
  description = "Base domain for environments"
  type        = string
  default     = "app.example.com"
}

variable "hosted_zone_id" {
  description = "Route53 hosted zone ID"
  type        = string
}

variable "certificate_arn" {
  description = "ACM certificate ARN for TLS"
  type        = string
}

variable "ssh_key_pair" {
  description = "EC2 key pair name for SSH access"
  type        = string
}

variable "default_instance_type" {
  description = "Default EC2 instance type"
  type        = string
  default     = "t3.small"
}

variable "ses_identity_arn" {
  description = "AWS SES verified identity ARN"
  type        = string
  default     = ""
}

variable "ses_smtp_username" {
  description = "AWS SES SMTP username"
  type        = string
  default     = ""
}

variable "ses_smtp_password" {
  description = "AWS SES SMTP password"
  type        = string
  sensitive   = true
  default     = ""
}
```

## Shared Infrastructure

```hcl
# Application Load Balancer (shared across environments)
module "alb" {
  build = "./modules/alb"
  inputs = {
    name            = "cldctl-alb"
    vpc_id          = variable.vpc_id
    certificate_arn = variable.certificate_arn
  }
}
```

## Environment Configuration

```hcl
environment {
  module "target_group" {
    build = "./modules/alb-target-group"
    inputs = {
      name    = environment.name
      vpc_id  = variable.vpc_id
      alb_arn = module.alb.arn
    }
  }

  module "security_group" {
    build = "./modules/security-group"
    inputs = {
      name   = "${environment.name}-sg"
      vpc_id = variable.vpc_id
    }
  }

  module "log_group" {
    build = "./modules/cloudwatch-logs"
    inputs = {
      name           = "/ec2/${environment.name}"
      retention_days = 30
    }
  }
}
```

## Resource Hooks

### Database Hook (RDS)

```hcl
database {
  module "rds_database" {
    build = "./modules/rds-database"
    inputs = {
      name              = "${environment.name}-${node.name}"
      type              = element(split(":", node.inputs.type), 0)
      version           = try(element(split(":", node.inputs.type), 1), null)
      region            = variable.aws_region
      vpc_id            = variable.vpc_id
      instance_class    = "db.t3.micro"
      allocated_storage = 20
      security_group_id = module.security_group.id
    }
  }

  outputs = {
    host     = module.rds_database.endpoint
    port     = module.rds_database.port
    database = module.rds_database.database_name
    url      = module.rds_database.connection_url
  }
}
```

### Task Hook (EC2 via SSM)

One-time tasks run on temporary EC2 instances:

```hcl
task {
  module "ec2_task" {
    plugin = "opentofu"
    build  = "./modules/ec2-task"
    inputs = {
      name              = "${node.component}--${node.name}"
      region            = variable.aws_region
      vpc_id            = variable.vpc_id
      security_group_id = module.security_group.id
      key_pair          = variable.ssh_key_pair
      instance_type     = variable.default_instance_type
      image             = node.inputs.image
      command           = node.inputs.command
      environment       = node.inputs.environment
    }
  }

  outputs = {
    id     = module.ec2_task.instance_id
    status = module.ec2_task.status
  }
}
```

### Bucket Hook (S3)

```hcl
bucket {
  module "s3_bucket" {
    build = "./modules/s3-bucket"
    inputs = {
      name       = "${environment.name}-${node.name}"
      region     = variable.aws_region
      versioning = node.inputs.versioning
      public     = node.inputs.public
    }
  }

  outputs = {
    endpoint        = "https://s3.${variable.aws_region}.amazonaws.com"
    bucket          = module.s3_bucket.bucket_name
    region          = variable.aws_region
    accessKeyId     = module.s3_bucket.access_key_id
    secretAccessKey = module.s3_bucket.secret_access_key
  }
}
```

### Encryption Key Hook (KMS + Secrets Manager)

```hcl
# Asymmetric keys (RSA/ECDSA)
encryptionKey {
  when = node.inputs.keyType == "rsa" || node.inputs.keyType == "ecdsa"

  module "asymmetric_key" {
    build = "./modules/secrets-manager-keypair"
    inputs = {
      name     = "${environment.name}/${node.component}/${node.name}"
      key_type = node.inputs.keyType
      key_size = node.inputs.keySize
      region   = variable.aws_region
    }
  }

  outputs = {
    privateKey       = module.asymmetric_key.private_key
    publicKey        = module.asymmetric_key.public_key
    privateKeyBase64 = module.asymmetric_key.private_key_base64
    publicKeyBase64  = module.asymmetric_key.public_key_base64
  }
}

# Symmetric keys
encryptionKey {
  when = node.inputs.keyType == "symmetric"

  module "symmetric_key" {
    build = "./modules/kms-key"
    inputs = {
      name   = "${environment.name}-${node.component}-${node.name}"
      region = variable.aws_region
    }
  }

  outputs = {
    key       = module.symmetric_key.key_material
    keyBase64 = module.symmetric_key.key_material_base64
  }
}
```

### SMTP Hook (SES)

```hcl
smtp {
  module "ses_smtp" {
    build = "./modules/ses-smtp"
    inputs = {
      region       = variable.aws_region
      identity_arn = variable.ses_identity_arn
    }
  }

  outputs = {
    host     = "email-smtp.${variable.aws_region}.amazonaws.com"
    port     = 587
    username = variable.ses_smtp_username
    password = variable.ses_smtp_password
  }
}
```

### Deployment Hook - Container (EC2 + Docker)

Container-based deployments provision an EC2 instance, install Docker, and run the container:

```hcl
deployment {
  when = node.inputs.image != null

  module "ec2_docker" {
    plugin = "opentofu"
    build  = "./modules/ec2-docker"
    inputs = merge(node.inputs, {
      name              = "${environment.name}-${node.component}-${node.name}"
      region            = variable.aws_region
      vpc_id            = variable.vpc_id
      security_group_id = module.security_group.id
      key_pair          = variable.ssh_key_pair
      instance_type     = variable.default_instance_type
      target_group_arn  = module.target_group.arn
      log_group         = module.log_group.name
    })
  }

  outputs = {
    id = module.ec2_docker.instance_id
  }
}
```

The `ec2-docker` module:
1. Launches an EC2 instance with Amazon Linux 2
2. Installs Docker via user data script
3. Authenticates with ECR and pulls the container image
4. Runs the container as a systemd service
5. Registers the instance with the ALB target group

### Deployment Hook - Runtime (EC2 + Language)

Runtime-based deployments install the language directly on EC2:

```hcl
deployment {
  when = node.inputs.runtime != null && node.inputs.image == null

  module "ec2_runtime" {
    plugin = "opentofu"
    build  = "./modules/ec2-runtime"
    inputs = merge(node.inputs, {
      name              = "${environment.name}-${node.component}-${node.name}"
      region            = variable.aws_region
      vpc_id            = variable.vpc_id
      security_group_id = module.security_group.id
      key_pair          = variable.ssh_key_pair
      instance_type     = variable.default_instance_type
      target_group_arn  = module.target_group.arn
      log_group         = module.log_group.name
    })
  }

  outputs = {
    id = module.ec2_runtime.instance_id
  }
}
```

The `ec2-runtime` module:
1. Selects an AMI based on the OS/arch requirements
2. Installs the specified language runtime (e.g., Node.js 20, Python 3.12)
3. Installs system packages if specified
4. Runs setup commands
5. Creates a systemd service for the application

### Function Hook (EC2 Process)

Functions deploy as long-running HTTP server processes on EC2 behind ALB:

```hcl
function {
  module "ec2_function" {
    plugin = "opentofu"
    build  = "./modules/ec2-function"
    inputs = merge(node.inputs, {
      name              = "${environment.name}-${node.component}-${node.name}"
      region            = variable.aws_region
      vpc_id            = variable.vpc_id
      security_group_id = module.security_group.id
      key_pair          = variable.ssh_key_pair
      instance_type     = variable.default_instance_type
      target_group_arn  = module.target_group.arn
      log_group         = module.log_group.name
    })
  }

  outputs = {
    id       = module.ec2_function.instance_id
    endpoint = "http://${module.ec2_function.private_ip}:${module.ec2_function.port}"
  }
}
```

### Route Hook (ALB)

```hcl
route {
  module "alb_listener_rule" {
    build = "./modules/alb-listener-rule"
    inputs = merge(node.inputs, {
      alb_arn          = module.alb.arn
      target_group_arn = module.target_group.arn
      domain           = "${environment.name}.${variable.domain}"
    })
  }

  outputs = {
    url      = "https://${environment.name}.${variable.domain}"
    hosts    = ["${environment.name}.${variable.domain}"]
    protocol = "https"
    host     = "${environment.name}.${variable.domain}"
    port     = 443
  }
}
```

### Cronjob Hook (EC2 Cron)

```hcl
cronjob {
  module "ec2_cronjob" {
    plugin = "opentofu"
    build  = "./modules/ec2-cronjob"
    inputs = merge(node.inputs, {
      name              = "${environment.name}-${node.component}-${node.name}"
      region            = variable.aws_region
      vpc_id            = variable.vpc_id
      security_group_id = module.security_group.id
      key_pair          = variable.ssh_key_pair
      instance_type     = "t3.micro"
    })
  }

  outputs = {
    id = module.ec2_cronjob.instance_id
  }
}
```

### Docker Build Hook (ECR)

```hcl
dockerBuild {
  module "ecr_build" {
    build = "./modules/ecr-build"
    inputs = {
      context    = node.inputs.context
      dockerfile = node.inputs.dockerfile
      target     = node.inputs.target
      args       = node.inputs.args
      region     = variable.aws_region
    }
  }

  outputs = {
    image = module.ecr_build.image_uri
  }
}
```

### Observability Hook (CloudWatch Agent)

Installs the CloudWatch agent on EC2 instances with an OTel collector sidecar:

```hcl
observability {
  module "cloudwatch_agent" {
    build = "./modules/cloudwatch-agent"
    inputs = {
      name      = "${environment.name}-observability"
      region    = variable.aws_region
      log_group = module.log_group.name
    }
  }

  outputs = {
    endpoint       = module.cloudwatch_agent.otlp_endpoint
    protocol       = "http/protobuf"
    query_type     = "cloudwatch"
    query_endpoint = "https://logs.${variable.aws_region}.amazonaws.com"
    dashboard_url  = "https://${variable.aws_region}.console.aws.amazon.com/cloudwatch/home"
    attributes = {
      "cloud.provider" = "aws"
      "cloud.region"   = variable.aws_region
      "cloud.platform" = "aws_ec2"
    }
  }
}
```

## Deploying

```bash
# Build the datacenter
cldctl dc build . -t ghcr.io/myorg/aws-vms-dc:v1.0.0
cldctl dc push ghcr.io/myorg/aws-vms-dc:v1.0.0

# Deploy with variables
cldctl dc deploy aws-vms-prod \
  --config ghcr.io/myorg/aws-vms-dc:v1.0.0 \
  --var vpc_id=vpc-12345 \
  --var domain=app.example.com \
  --var hosted_zone_id=Z123456 \
  --var certificate_arn=arn:aws:acm:... \
  --var ssh_key_pair=my-key-pair \
  --var ses_identity_arn=arn:aws:ses:... \
  --var ses_smtp_username=$SES_USERNAME \
  --var ses_smtp_password=$SES_PASSWORD

# Create environment and deploy
cldctl env create staging --datacenter aws-vms-prod
cldctl deploy ghcr.io/myorg/my-app:v1.0.0 -e staging
```

## How It Works

### Container Deployments on EC2

When a component has a Docker image (`node.inputs.image != null`):
1. An EC2 instance is provisioned via OpenTofu
2. Docker is installed via user data script
3. The container image is pulled from ECR
4. The container runs as a systemd service
5. The instance registers with the ALB target group

### Runtime Deployments on EC2

When a component has a runtime (`node.inputs.runtime != null`):
1. An EC2 instance is provisioned via OpenTofu
2. The specified language runtime is installed (e.g., `node:20`, `python:3.12`)
3. System packages from `runtime.packages` are installed
4. Setup commands from `runtime.setup` are executed
5. The application runs as a systemd service

### Functions on EC2

Functions deploy as persistent HTTP server processes:
1. An EC2 instance is provisioned
2. The function handler runs as a long-lived process
3. The ALB routes traffic to the instance
4. Unlike Lambda, there are no cold starts or timeout limits

## Cost Optimization

- Use Reserved Instances or Savings Plans for predictable workloads
- Use `t3.micro` for cronjobs and low-traffic services
- Consolidate multiple small services onto larger instances
- Use Auto Scaling Groups for variable traffic
- RDS t3.micro for development environments

## Related Guides

<CardGroup cols={2}>
  <Card title="AWS ECS Fargate" href="/guides/datacenters/aws-ecs">
    Container-based AWS deployment with ECS
  </Card>
  <Card title="AWS Lambda" href="/guides/datacenters/aws-lambda">
    Serverless-first AWS deployment with Lambda
  </Card>
  <Card title="AWS Kubernetes (EKS)" href="/guides/datacenters/aws-k8s">
    Kubernetes on AWS with EKS
  </Card>
  <Card title="Managing Environments" href="/guides/managing-environments">
    Day-to-day environment operations
  </Card>
</CardGroup>
