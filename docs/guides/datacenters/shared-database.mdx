---
title: "Shared Database for Previews"
description: "Cost-effective datacenter with shared database cluster for preview environments"
---

# Shared Database Datacenter

This guide shows how to build a cost-effective datacenter that uses a shared database cluster for preview/ephemeral environments.

<Info>
Example source: `examples/datacenters/shared-database/`
</Info>

## Overview

This datacenter provides:
- **Shared PostgreSQL cluster** for all environments
- **Logical database isolation** per environment
- **Kubernetes namespaces** for compute isolation
- **Cost-effective preview environments**

## The Problem

Running separate database instances for each preview environment is expensive:
- Preview-123: RDS instance ($15/month)
- Preview-124: RDS instance ($15/month)
- Preview-125: RDS instance ($15/month)
- ...costs add up quickly!

## The Solution

Share a single database cluster with logical isolation:
- One PostgreSQL cluster (shared)
- Separate database per environment (logical isolation)
- Separate Redis key prefix per environment
- Full compute isolation via Kubernetes namespaces

## Configuration Variables

```hcl
variable "cluster_name" {
  description = "Kubernetes cluster name"
  type        = string
}

variable "domain" {
  description = "Base domain for environments"
  type        = string
  default     = "preview.example.com"
}

# Shared database connection info
variable "shared_postgres_host" {
  description = "Shared PostgreSQL cluster host"
  type        = string
}

variable "shared_postgres_admin_user" {
  description = "Admin user for shared PostgreSQL"
  type        = string
  sensitive   = true
}

variable "shared_postgres_admin_password" {
  description = "Admin password for shared PostgreSQL"
  type        = string
  sensitive   = true
}

variable "shared_redis_host" {
  description = "Shared Redis cluster host"
  type        = string
}
```

## Environment Configuration

```hcl
environment {
  # Kubernetes namespace per environment
  module "namespace" {
    build = "./modules/k8s-namespace"
    inputs = {
      name    = environment.name
      cluster = variable.cluster_name
    }
  }

  # Create logical database in shared cluster
  module "postgres_database" {
    when  = contains(environment.nodes.*.inputs.databaseType, "postgres")
    build = "./modules/postgres-logical-db"
    inputs = {
      host           = variable.shared_postgres_host
      admin_user     = variable.shared_postgres_admin_user
      admin_password = variable.shared_postgres_admin_password
      database_name  = replace(environment.name, "-", "_")
    }
  }

  # Redis key prefix for logical isolation
  module "redis_namespace" {
    when  = contains(environment.nodes.*.inputs.databaseType, "redis")
    build = "./modules/redis-namespace"
    inputs = {
      host       = variable.shared_redis_host
      key_prefix = environment.name
    }
  }
}
```

## Resource Hooks

### Database Hook (Shared)

```hcl
database {
  module "shared_database" {
    build = "./modules/shared-database"
    inputs = {
      name        = node.name
      type        = node.inputs.databaseType
      environment = environment.name
      # PostgreSQL: use shared cluster with environment-specific database
      postgres_host     = variable.shared_postgres_host
      postgres_database = module.postgres_database.database_name
      # Redis: use shared cluster with key prefix
      redis_host       = variable.shared_redis_host
      redis_key_prefix = environment.name
    }
  }

  outputs = {
    host     = module.shared_database.host
    port     = module.shared_database.port
    database = module.shared_database.database
    url      = module.shared_database.url
  }
}
```

### Deployment Hook (Minimal Resources)

```hcl
deployment {
  module "deployment" {
    build = "./modules/k8s-deployment"
    inputs = {
      name        = node.name
      namespace   = environment.name
      image       = node.inputs.image
      environment = node.inputs.environment
      # Smaller resources for preview environments
      cpu      = "0.25"
      memory   = "256Mi"
      replicas = 1
    }
  }

  outputs = {
    id = module.deployment.deployment_id
  }
}
```

### Function Hook (Scale-to-Zero)

```hcl
function {
  module "knative_service" {
    build = "./modules/knative-service"
    inputs = {
      name          = node.name
      namespace     = environment.name
      image         = node.inputs.image
      memory        = "512Mi"
      scale_to_zero = true  # Cost saving!
    }
  }

  outputs = {
    id       = module.knative_service.service_id
    endpoint = module.knative_service.url
  }
}
```

### Cronjob Hook (Disabled)

```hcl
cronjob {
  # Disable cronjobs in preview environments
  module "cronjob_disabled" {
    build = "./modules/k8s-cronjob-disabled"
    inputs = {
      name      = node.name
      namespace = environment.name
      suspended = true  # Don't run in previews
    }
  }

  outputs = {
    id = "disabled-${node.name}"
  }
}
```

## Isolation Model

### Database Isolation

| Level | PostgreSQL | Redis |
|-------|------------|-------|
| **Cluster** | Shared | Shared |
| **Database** | Separate per env | Shared |
| **Users** | Separate per env | Shared |
| **Keys** | N/A | Prefixed per env |

### Compute Isolation

| Level | Kubernetes |
|-------|------------|
| **Cluster** | Shared |
| **Namespace** | Separate per env |
| **Network Policy** | Isolated per env |

## Cost Comparison

### Traditional (Dedicated per Environment)

| Resource | Per Environment | 10 Previews |
|----------|-----------------|-------------|
| RDS Instance | $15/month | $150/month |
| ElastiCache | $13/month | $130/month |
| **Total** | $28/month | $280/month |

### Shared Database Approach

| Resource | Shared | 10 Previews |
|----------|--------|-------------|
| RDS Instance | $15/month | $15/month |
| ElastiCache | $13/month | $13/month |
| **Total** | $28/month | $28/month |

**Savings: ~90% for preview environments**

## Deploying

```bash
# Deploy the shared database cluster first (separate IaC)
# Then deploy the datacenter

arcctl dc build . -t ghcr.io/myorg/preview-dc:v1.0.0
arcctl dc push ghcr.io/myorg/preview-dc:v1.0.0

arcctl dc deploy preview-cluster \
  --config ghcr.io/myorg/preview-dc:v1.0.0 \
  --var cluster_name=preview-k8s \
  --var shared_postgres_host=shared-db.example.com \
  --var shared_postgres_admin_user=$PG_USER \
  --var shared_postgres_admin_password=$PG_PASSWORD \
  --var shared_redis_host=shared-redis.example.com

# Create preview environments (instant, cheap!)
arcctl env create preview-123 --datacenter preview-cluster
arcctl deploy ghcr.io/myorg/my-app:pr-123 -e preview-123
```

## Cleanup

When previews are destroyed, clean up logical databases:

```hcl
# The postgres-logical-db module handles cleanup
# Database is dropped when environment is destroyed
```

## When to Use

**Good for:**
- Preview/PR environments
- Development environments
- Testing environments
- Cost-sensitive deployments

**Not recommended for:**
- Production (use dedicated databases)
- Staging (may want production-like isolation)
- Performance testing (shared resources affect results)

## Related Guides

<CardGroup cols={2}>
  <Card title="Shared Database Component" href="/guides/components/shared-database">
    Component-level database sharing
  </Card>
  <Card title="CI/CD Integration" href="/guides/ci-cd-integration">
    Automate preview deployments
  </Card>
</CardGroup>
